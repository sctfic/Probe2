<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vecteurs de Vent - VP2_Serramoune</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #fafafa;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 300;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .chart-container {
            width: 100%;
            margin: 20px 0;
            border: 1px solid #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
        }
        
        /* Styles D3 pour le graphique */
        .axis {
            font-size: 12px;
        }
        
        .axis path,
        .axis line {
            fill: none;
            stroke: #bdc3c7;
            shape-rendering: crispEdges;
        }
        
        .axis text {
            fill: #7f8c8d;
        }
        
        .hair {
            stroke: #3182bd;
            stroke-width: 1.5;
            marker-end: url(#arrowhead);
        }
        
        .arrow:hover .hair {
            stroke: #E6550D;
            stroke-width: 3;
            marker-end: url(#arrowheadHover);
        }
        
        .arrow:hover .hair2 {
            stroke: #c0392b;
            stroke-width: 3;
        }
        
        .sensitive {
            fill: transparent;
            /* cursor: crosshair; */
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }
        
        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
            font-size: 12px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Vecteurs de Vent</h1>
        <div class="subtitle">Station VP2_Serramoune • 27 août - 10 septembre 2025</div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #3182bd;"></div>
                <span>Vent moyen</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>Rafales</span>
            </div>
        </div>
        
        <div class="controls">
            Utilisez la molette de la souris pour zoomer • Cliquez et glissez pour naviguer
        </div>
        
        <div class="chart-container" id="wind-chart"></div>
        
        <div class="stats" id="stats"></div>
    </div>

    <script>
        let windPoints = [];
        let allData = [];

        // Variables globales pour le graphique
        let svg, g, xScale, yScale, xAxis, yAxis, sensitive, zoomBehavior;
        const margin = {top: 10, right: 30, bottom: 30, left: 30};
        const width = 1200 - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;
        const vectorScale = 50; // Facteur d'échelle pour la longueur des vecteurs
        let zoomTimeout = null;

        // Fonction inspirée du code histoWind.js
        function createWindChart() {
            // Échelles comme dans le code original
            xScale = d3.scaleTime().range([0, width]);
            yScale = d3.scaleLinear().range([height, 0]);

            // Création du SVG
            svg = d3.select("#wind-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

            // Définition des marqueurs de flèches (comme dans le code original)
            const defs = svg.append("defs");

            defs.append("marker")
                .attr("id", "arrowhead")
                .attr("refX", 0)
                .attr("refY", 0)
                .attr("viewBox", "-5 -5 10 10")
                .attr("markerUnits", "strokeWidth")
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("polygon")
                .attr("fill", "#3182bd")
                .attr("points", "0,0 -2,-2 5,0 -2,2");

            defs.append("marker")
                .attr("id", "arrowheadHover")
                .attr("refX", 0)
                .attr("refY", 0)
                .attr("viewBox", "-5 -5 10 10")
                .attr("markerUnits", "strokeWidth")
                .attr("markerWidth", 8)
                .attr("markerHeight", 12)
                .attr("orient", "auto")
                .append("polygon")
                .attr("fill", "#E6550D")
                .attr("points", "0,0 -2,-2 5,0 -2,2");

            // Groupe principal
            g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Axes
            xAxis = d3.axisBottom(xScale)
                .tickFormat(d3.timeFormat("%d/%m"));
            
            yAxis = d3.axisLeft(yScale)
                .ticks(6);

            // Zone sensible pour le zoom (comme dans le code original)
            sensitive = g.append("rect")
                .attr("class", "sensitive")
                .attr("width", width)
                .attr("height", height);

            g.append("g").attr("class", "x axis");
            g.append("g").attr("class", "y axis");

            // Fonction de mise à jour des courbes (inspirée du code original)
            function updateArrows(currentXScale) {
                const xExtent = currentXScale.domain();
                
                // Vecteurs de vent moyen
                g.selectAll(".wind-arrow").remove(); // Redessin simple pour la clarté
                g.selectAll(".wind-arrow")
                    .data(windPoints.filter(d => d.spd > 0.01))
                    .enter()
                    .append("g")
                    .attr("class", "wind-arrow arrow")
                    .append("line")
                    .attr("class", "hair")
                    .attr("x1", d => currentXScale(d.date))
                    .attr("y1", yScale(0))
                    .attr("x2", d => currentXScale(d.date) + d.Ux * vectorScale)
                    .attr("y2", d => yScale(d.Vy))
                    .attr("display", d => (d.date >= xExtent[0] && d.date <= xExtent[1]) ? 'inline' : 'none')
                    .append("title")
                    .text(d => `Vent moyen: ${d.spd.toFixed(2)} m/s\nDirection: ${d.dir}°\nDate: ${d.date.toLocaleDateString()}`);
            }

            // Fonction de dessin des axes (inspirée du code original)
            function drawAxis() {
                let xPos;
                if (0 < yScale.domain()[0]) {
                    xPos = yScale.range()[0];
                } else if (yScale.domain()[1] < 0) {
                    xPos = yScale.range()[1];
                } else {
                    xPos = yScale(0);
                }

                g.select(".x.axis").remove();
                g.select(".y.axis").remove();

                g.append("g")
                    .attr("class", "x axis")
                    .attr("transform", `translate(0,${xPos})`)
                    .call(xAxis);

                g.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);
            }

            // Zoom et pan
            function zoomed(event) {
                const transform = event.transform;
                const newXScale = transform.rescaleX(xScale);
                g.select(".x.axis").call(xAxis.scale(newXScale));
                updateArrows(newXScale);
            }

            function zoomEnd(event) {
                clearTimeout(zoomTimeout);
                zoomTimeout = setTimeout(() => {
                    const newXScale = event.transform.rescaleX(xScale);
                    const [newStart, newEnd] = newXScale.domain();
                    console.log('zoomEnd',newStart, newEnd);
                    loadDataAndUpdate(newStart, newEnd);
                }, 500); // Debounce de 500ms
            }

            zoomBehavior = d3.zoom()
                .scaleExtent([0.1, 1000])
                .extent([[0, 0], [width, height]])
                .on("zoom", zoomed)
                .on("end", zoomEnd);

            sensitive.call(zoomBehavior);

            // Mise à jour du graphique avec de nouvelles données
            window.updateChart = function(windData) {
                const timeFormat = d3.timeParse("%Y-%m-%dT%H:%M:%SZ");
                windPoints = windData.data.map(d => ({date: timeFormat(d.d), ...d}));

                xScale.domain(d3.extent(windPoints, d => d.date));
                yScale.domain(d3.extent(windPoints, d => d.Vy));

                // Réinitialise l'état du zoom sans déclencher d'événement pour éviter une boucle
                sensitive.node().__zoom = d3.zoomIdentity;

                drawAxis();
                updateArrows(xScale);
            };
        }

        async function loadDataAndUpdate(startDate, endDate) {
            try {
                let url = `/query/VP2_Serramoune/WindVectors?stepCount=300`;
                if (startDate) url += `&startDate=${startDate.toISOString()}`;
                if (endDate) url += `&endDate=${endDate.toISOString()}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const windData = await response.json();

                if (window.updateChart) {
                    window.updateChart(windData);
                }
                displayStats(windData);
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                document.getElementById('wind-chart').innerHTML = 
                    `<p style="text-align: center; color: #e74c3c;">Erreur: ${error.message}</p>`;
            }
        }

        // Calcul des statistiques
        function displayStats(windData) {
            if (!windData || !windData.data) {
                document.getElementById('stats').innerHTML = '';
                return;
            }
            const windSpeeds = windData.data.map(d => d.spd).filter(s => s > 0);
            
            const avgWind = windSpeeds.length > 0 ? (windSpeeds.reduce((a, b) => a + b, 0) / windSpeeds.length) : 0;
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${avgWind.toFixed(2)}</div>
                    <div class="stat-label">Vent moyen (m/s)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${windData.data.length}</div>
                    <div class="stat-label">Mesures totales</div>
                </div>
            `;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            createWindChart();
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 15 * 24 * 60 * 60 * 1000); // 15 derniers jours
            loadDataAndUpdate(startDate, endDate);
        });
    </script>
</body>
</html>