<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse de Temp√©rature</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }

        .location-info {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìä Analyse de Temp√©rature Moyenne</h1>
        <div class="location-info">
            üìç Latitude: <span id="lat">43.2</span>¬∞ | Longitude: <span id="lon">-0.5</span>¬∞ | Altitude: <span
                id="alt">242</span>m
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            Chargement des donn√©es m√©t√©orologiques...
        </div>

        <div id="error" style="display: none;"></div>

        <div class="chart-container">
            <canvas id="tempChart"></canvas>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-label">Temp√©rature Moyenne</div>
                <div class="stat-value" id="avgTemp">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Temp√©rature Min</div>
                <div class="stat-value" id="minTemp">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Temp√©rature Max</div>
                <div class="stat-value" id="maxTemp">--</div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Calcule la moyenne mobile sur 7 jours
         */
        function calculerMoyenneMobile(temperatures, jours = 7) {
            const result = [];
            for (let i = 0; i < temperatures.length; i++) {
                let sum = 0;
                let count = 0;
                for (let j = Math.max(0, i - Math.floor(jours / 2)); j <= Math.min(temperatures.length - 1, i + Math.floor(jours / 2)); j++) {
                    if (temperatures[j] !== null) {
                        sum += temperatures[j];
                        count++;
                    }
                }
                result.push(count > 0 ? sum / count : null);
            }
            return result;
        }

        /**
         * R√©cup√®re les temp√©ratures moyennes des 10 derni√®res ann√©es
         * et calcule la tendance pour 60 jours pr√©c√©dents et 300 jours suivants
         */
        async function obtenirTemperaturesMoyennes(latitude, longitude, altitude) {
            const aujourdhui = new Date();
            const jourDansAnnee = Math.floor((aujourdhui - new Date(aujourdhui.getFullYear(), 0, 0)) / 86400000);

            // R√©cup√©rer les donn√©es des 10 derni√®res ann√©es
            const annees = [];
            for (let i = 0; i < 80; i++) {
                annees.push(aujourdhui.getFullYear() - i - 1);
            }

            const donneesAnnuelles = [];

            for (const annee of annees) {
                const startDate = `${annee}-01-01`;
                const endDate = `${annee}-12-31`;

                const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${latitude}&longitude=${longitude}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_mean&timezone=auto`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    donneesAnnuelles.push(data.daily.temperature_2m_mean);
                } catch (error) {
                    console.error(`Erreur pour l'ann√©e ${annee}:`, error);
                }
            }

            // Calculer la moyenne pour chaque jour de l'ann√©e
            const moyennesJournalieres = [];
            const nombreJours = 365;

            for (let jour = 0; jour < nombreJours; jour++) {
                let sum = 0;
                let count = 0;
                for (const annee of donneesAnnuelles) {
                    if (annee[jour] !== null && annee[jour] !== undefined) {
                        sum += annee[jour];
                        count++;
                    }
                }
                moyennesJournalieres.push(count > 0 ? sum / count : null);
            }

            // Appliquer la moyenne mobile sur 7 jours
            const moyennesLissees = moyennesJournalieres; //calculerMoyenneMobile(moyennesJournalieres, 7);

            // Extraire 60 jours avant et 300 jours apr√®s
            const result = [];
            const dates = [];

            for (let i = -60; i <= 300; i++) {
                let jourIndex = (jourDansAnnee + i + 365 * 2) % 365;
                result.push(moyennesLissees[jourIndex]);

                const date = new Date(aujourdhui);
                date.setDate(date.getDate() + i);
                dates.push(date.toLocaleDateString('fr-FR'));
            }

            return { temperatures: result, dates: dates };
        }

        // Configuration GPS
        const gps = {
            latitude: 43.2,
            longitude: -0.5,
            altitude: 242.01
        };

        // Initialisation
        let chart = null;

        async function initialiser() {
            document.getElementById('lat').textContent = gps.latitude;
            document.getElementById('lon').textContent = gps.longitude;
            document.getElementById('alt').textContent = gps.altitude.toFixed(0);

            try {
                const donnees = await obtenirTemperaturesMoyennes(gps.latitude, gps.longitude, gps.altitude);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats').style.display = 'grid';

                // Calculer les statistiques
                const tempsValides = donnees.temperatures.filter(t => t !== null);
                const moyenne = tempsValides.reduce((a, b) => a + b, 0) / tempsValides.length;
                const min = Math.min(...tempsValides);
                const max = Math.max(...tempsValides);

                document.getElementById('avgTemp').textContent = moyenne.toFixed(1) + '¬∞C';
                document.getElementById('minTemp').textContent = min.toFixed(1) + '¬∞C';
                document.getElementById('maxTemp').textContent = max.toFixed(1) + '¬∞C';

                // Cr√©er le graphique
                const ctx = document.getElementById('tempChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: donnees.dates,
                        datasets: [{
                            label: 'Temp√©rature moyenne (7j glissant)',
                            data: donnees.temperatures,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function (context) {
                                        return 'Temp√©rature: ' + context.parsed.y.toFixed(1) + '¬∞C';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Date'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    maxTicksLimit: 20
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Temp√©rature (¬∞C)'
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').className = 'error';
                document.getElementById('error').textContent = 'Erreur lors du chargement des donn√©es: ' + error.message;
            }
        }

        // Lancer l'initialisation
        initialiser();
    </script>
</body>

</html>